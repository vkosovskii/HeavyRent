# user-service

Resource Server for HeavyRent. Manages user profiles. Validates JWT tokens issued by auth-service via JWKS.

## Responsibilities

- Storing and managing user profiles in PostgreSQL
- Validating JWT tokens on every request (via JWKS from auth-service)
- Auto-creating user profile on first login (`findOrCreate`)
- Providing user data to other internal services

## Endpoints

| Method | URL | Auth | Description |
|--------|-----|------|-------------|
| GET | `/api/users/me` | Bearer token | Get current user profile |
| PUT | `/api/users/me` | Bearer token | Update current user profile |
| GET | `/api/users/{id}` | Bearer token (ADMIN) | Get user by ID |

## How Token Validation Works

user-service does **not** call auth-service on every request. Instead:

1. On startup, fetches public RSA key from `http://localhost:8080/oauth2/jwks` (cached)
2. On each request, validates JWT signature locally using the cached public key
3. Extracts `sub` (email) from token payload
4. Uses email to find or create user in PostgreSQL

This means user-service works independently — no auth-service dependency per request.

## API Examples

### Get current user profile

```bash
curl http://localhost:8081/api/users/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN"
```

Response:

```json
{
  "email": "user@heavyrent.com",
  "firstName": null,
  "lastName": null,
  "phone": null,
  "isVerified": false,
  "status": "UNVERIFIED",
  "role": null,
  "updatedAt": "2026-02-21T13:40:03.649546"
}
```

### Update current user profile

```bash
curl -X PUT http://localhost:8081/api/users/me \
  -H "Authorization: Bearer YOUR_ACCESS_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "firstName": "Ivan",
    "lastName": "Petrov",
    "phone": "+7 999 123 45 67"
  }'
```

## Database Schema

Table: `user_profiles`

| Column | Type | Constraints |
|--------|------|-------------|
| id | bigint | PK, auto-increment |
| email | varchar | unique, not null |
| first_name | varchar | nullable |
| last_name | varchar | nullable |
| phone | varchar | nullable |
| is_verified | boolean | not null, default false |
| status | varchar | ACTIVE / INACTIVE / BANNED / UNVERIFIED |
| role | varchar | RENTER / OWNER / ADMIN |
| created_at | timestamp | set on create |
| updated_at | timestamp | set on update |

Schema is auto-generated by Hibernate on startup (`ddl-auto: update`).

## Configuration

```yaml
server:
  port: 8081

spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/heavyrent_users
    username: postgres
    password: postgres

  security:
    oauth2:
      resourceserver:
        jwt:
          jwk-set-uri: http://localhost:8080/oauth2/jwks
```

## Prerequisites

- PostgreSQL running on port 5432 (see root README for Docker setup)
- auth-service running on port 8080 (needed for JWKS on startup)

## Running

```bash
./gradlew :user-service:bootRun
```

Service starts on `http://localhost:8081`

## Package Structure

```
com.heavyrent.user
├── controller/         # REST endpoints (UserProfileController)
├── service/            # Business logic (UserProfileService)
├── repository/         # DB access (UserProfileRepository)
├── model/              # JPA entities (UserProfile)
└── dto/                # API contracts
    ├── UserUpdateRequest.java   # PUT request body
    └── UserProfileResponse.java # API response
```